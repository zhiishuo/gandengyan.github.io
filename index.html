<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>干瞪眼 · 记分板 · Diamanté</title>

<!-- PWA 基本配置 -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0e1116">

<!-- iOS PWA 元标签 -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="记分板">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="stylesheet" href="style.css">

<!-- 预览列样式（正绿/负红/零灰） -->
<style>
  .previewCell{ text-align:right; }
  .previewVal{ font-weight:800; letter-spacing:.2px; }
  .previewVal.pos{ color:#16a34a; }   /* 正数：绿 */
  .previewVal.neg{ color:#f87171; }   /* 负数：红 */
  .previewVal.zero{ color:#cbd5e1; }  /* 0：灰 */
</style>
</head>
<body>

  <div class="viewport">
    <div class="pages" id="pages">
      <!-- Page 0: 玩家 -->
      <section class="page" data-page="players">
        <div class="panel">
          <h2>玩家设置</h2>
          <div class="flex">
            <span class="pill">人数：<b id="playerCountEcho">7</b></span>
            <button class="btn" id="minusP">－1</button>
            <button class="btn" id="plusP">＋1</button>
          </div>
          <div class="flex" style="margin-top:8px">
            <label>设为：<input id="setP" class="mono num" value="7"></label>
            <button class="btn accent" id="applyP">应用人数</button>
          </div>
          <table style="margin-top:8px">
            <thead><tr><th>#</th><th>玩家名</th><th>分</th></tr></thead>
            <tbody id="playersBody"></tbody>
          </table>
          <div class="flex" style="margin-top:8px">
            <button class="btn accent" id="resetNames">重置名字</button>
            <button class="btn" id="zeroScores">分数清零</button>
          </div>
        </div>
      </section>

      <!-- Page 1: 记分 -->
      <section class="page" data-page="score">
        <div class="panel">
          <!-- 红色炸弹卡（仅加/减/重置） -->
          <div class="bombCard" id="bombCard">
            <div class="bombValue mono" id="bombValue">💣 炸弹 0 ｜ 倍数 ×1</div>
            <div class="bombBtns">
              <button class="btn" id="bombDec">－</button>
              <button class="btn" id="bombInc">＋</button>
              <button class="btn" id="bombReset">重置</button>
            </div>
          </div>

          <!-- 模式选择（赢家只通过下方按钮选择） -->
          <div class="flex" style="margin-top:12px">
            <label>模式
              <select id="mode">
                <option value="remain" selected>剩牌结算</option>
                <option value="winner1">胜者 +1</option>
                <option value="manual">手工输入</option>
              </select>
            </label>
          </div>

          <!-- 赢家：点名字选择（用于 remain 快速切换赢家） -->
          <div class="flex" id="winnerQuick" style="margin-top:8px"></div>

          <!-- 剩牌 / 春天（每行春天=单按钮） -->
          <div id="modeRemain" style="margin-top:8px">
            <table>
              <thead><tr><th>#</th><th>玩家</th><th>剩牌</th><th>春天</th><th>预览</th></tr></thead>
              <tbody id="remainBody"></tbody>
            </table>
          </div>

          <!-- 胜者+1：在 winner1 模式下显示 -->
          <div id="modeWinner1" style="display:none; margin-top:8px">
            <div class="muted">点选本轮胜者：</div>
            <div id="winnerList" class="flex" style="gap:8px; flex-wrap:wrap; margin-top:6px"></div>
          </div>

          <!-- 手工输入 -->
          <div id="modeManual" style="display:none; margin-top:8px">
            <table>
              <thead><tr><th>#</th><th>玩家</th><th>分</th></tr></thead>
              <tbody id="manualBody"></tbody>
            </table>
          </div>

          <!-- 预览 + 入账（保留，作为对照/提示用） -->
          <div class="panel" style="margin-top:10px">
            <div class="flex" style="justify-content:space-between">
              <span class="muted">本轮预览（含倍数/春天）</span>
              <span class="pill">仅预览</span>
            </div>
            <div id="previewBox" class="mono" style="margin-top:6px; color:#fff5f5">—</div>
            <div id="winnerPot" class="mono" style="margin-top:6px; color:#ffdede"></div>
            <div class="flex" style="margin-top:10px; justify-content:flex-end"></div>
          </div>
        </div>
      </section>

      <!-- Page 2: 实时排名 -->
      <section class="page" data-page="rank">
        <div class="panel">
          <div class="rankHeader">
            <h2>实时排名</h2>
            <div class="sub" id="rankMeta">—</div>
          </div>
          <div class="rankList" id="rankList"></div>
        </div>
      </section>

      <!-- Page 3: 历史 -->
      <section class="page" data-page="history">
        <div class="panel">
          <h2>回合历史</h2>
          <table>
            <thead><tr><th>#</th><th>明细</th><th>操作</th></tr></thead>
            <tbody id="historyBody"></tbody>
          </table>
          <div class="flex" style="margin-top:8px">
            <button class="btn warn" id="clearHistory">清空历史</button>
            <button class="btn" id="exportCsv">导出 CSV</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- 记分页专属：停靠小计条 -->
  <div class="subtotalDock" id="subtotalDock" aria-live="polite">
    <div class="dockInner">
      <div>当前倍数：<b class="mono" id="dockMult">×1</b></div>
      <div>赢家预计进账：<b class="mono" id="dockPot">+0</b></div>
      <!-- 小计条内 -->
      <div class="dockActions" role="group" aria-label="入账与撤销">
        <button id="commit_m" class="gbtn primary" type="button">
          <span class="gbtn-ico">✔</span><span>入账</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 底部 Tab -->
  <nav class="tabbar">
    <button class="tabbtn" data-tab="players" aria-label="玩家">
      <span class="ico" aria-hidden="true">
        <!-- People / Players -->
        <svg viewBox="0 0 24 24" width="24" height="24">
          <circle cx="8" cy="8" r="3"></circle>
          <circle cx="16" cy="9" r="2.5"></circle>
          <path d="M3 19c0-3 3-5 6-5s6 2 6 5"></path>
          <path d="M13.5 14.5c2.4.4 4.5 2 4.5 4.5"></path>
        </svg>
      </span>
      玩家
    </button>

    <button class="tabbtn active" data-tab="score" aria-label="记分">
      <span class="ico" aria-hidden="true">
        <!-- Clipboard / Score -->
        <svg viewBox="0 0 24 24" width="24" height="24">
          <rect x="5" y="5" width="14" height="15" rx="2"></rect>
          <path d="M9 5h6v3H9z"></path>
          <path d="M8 12h8M8 16h8"></path>
        </svg>
      </span>
      记分
    </button>

    <button class="tabbtn" data-tab="rank" aria-label="排名">
      <span class="ico" aria-hidden="true">
        <!-- Trophy / Rank -->
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path d="M8 4h8v2a4 4 0 0 1-8 0V4z"></path>
          <path d="M4 6h4a5 5 0 0 1-5 5V8a2 2 0 0 1 1-2z"></path>
          <path d="M20 6h-4a5 5 0 0 0 5 5V8a2 2 0 0 0-1-2z"></path>
          <path d="M10 15h4v4h-4z"></path>
          <path d="M8 19h8"></path>
        </svg>
      </span>
      排名
    </button>

    <button class="tabbtn" data-tab="history" aria-label="历史">
      <span class="ico" aria-hidden="true">
        <!-- Clock / History -->
        <svg viewBox="0 0 24 24" width="24" height="24">
          <circle cx="12" cy="12" r="8"></circle>
          <path d="M12 8v5l3 2"></path>
        </svg>
      </span>
      历史
    </button>
  </nav>

  <!-- 入账成功提醒 -->
  <div class="toast" id="toast">✅ 入账成功</div>

  <!-- 你的主逻辑 -->
  <script src="app.js" defer></script>

  <!-- 预览列注入与计算（依赖 app.js 中的 state / roundDraft） -->
  <script defer>
  (function(){
    // 安全取数
    function num(x){ x = Number(x); return isFinite(x) ? x : 0; }

    // 给 #remainBody 的每一行补上“预览”单元格：<td class="previewCell"><span class="previewVal mono zero" data-idx="i">+0</span></td>
    function ensurePreviewCells(){
      const tbody = document.getElementById('remainBody');
      if(!tbody) return;
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.forEach((tr, i) => {
        // 如果已有 previewCell，就只更新 data-idx
        let cell = tr.querySelector('.previewCell');
        if(!cell){
          cell = document.createElement('td');
          cell.className = 'previewCell';
          const span = document.createElement('span');
          span.className = 'previewVal mono zero';
          span.dataset.idx = String(i);
          span.textContent = '+0';
          cell.appendChild(span);
          tr.appendChild(cell);
        }else{
          const span = cell.querySelector('.previewVal');
          if(span) span.dataset.idx = String(i);
        }
      });
    }

    // 计算并渲染“本轮预览”
    function renderRoundPreview(){
      try{
        const N = (window.state && Array.isArray(state.players)) ? state.players.length : 0;
        if(!N) return;

        const w = num(window.state && state.remainWinner);
        const mult = Math.pow(2, Math.max(0, num(window.state && state.bombCount)));

        // 初始化
        document.querySelectorAll('.previewVal').forEach(el=>{
          el.textContent = '+0';
          el.classList.remove('pos','neg','zero');
          el.classList.add('zero');
        });

        if(!(w >= 0 && w < N)) return; // 未选择赢家

        let winnerGain = 0;

        for(let i=0;i<N;i++){
          const remain = num(window.roundDraft && roundDraft.remain && roundDraft.remain[i]);
          const spring = !!(window.roundDraft && roundDraft.springs && roundDraft.springs[i]);
          const cell = document.querySelector(`.previewVal[data-idx="${i}"]`);
          if(!cell) continue;

          if(i === w){
            cell.textContent = '+0';
            cell.classList.remove('pos','neg','zero');
            cell.classList.add('zero');
          }else{
            let base = remain;
            if(spring) base *= 2;       // 春天翻倍
            const lose = base * mult;   // 乘炸弹倍数
            const val = -lose;          // 输家为负

            winnerGain += lose;

            cell.textContent = (val >= 0 ? '+' : '') + String(val);
            cell.classList.remove('pos','neg','zero');
            cell.classList.add(val > 0 ? 'pos' : (val < 0 ? 'neg' : 'zero'));
          }
        }

        const wcell = document.querySelector(`.previewVal[data-idx="${w}"]`);
        if(wcell){
          wcell.textContent = '+' + String(winnerGain);
          wcell.classList.remove('pos','neg','zero');
          wcell.classList.add(winnerGain > 0 ? 'pos' : (winnerGain < 0 ? 'neg' : 'zero'));
        }

        // 同步底部小计条的赢家进账（若需要）
        const dockPot = document.getElementById('dockPot');
        if(dockPot){
          dockPot.textContent = '+' + String(winnerGain);
        }
      }catch(e){
        // console.debug('renderRoundPreview error', e);
      }
    }

    // 监听 DOM 变化（当 app.js 重新渲染 #remainBody 时，自动补列并刷新）
    const remainBody = document.getElementById('remainBody');
    if(remainBody){
      const mo = new MutationObserver(()=>{
        ensurePreviewCells();
        // 等渲染稳定一帧再算，避免取不全
        requestAnimationFrame(renderRoundPreview);
      });
      mo.observe(remainBody, {childList:true, subtree:true, characterData:true});
    }

    // 关键交互后刷新
    function bindLiveRefresh(){
      // 初始
      ensurePreviewCells();
      renderRoundPreview();

      // 剩牌输入/春天输入
      document.addEventListener('input', (e)=>{
        if(e.target && (e.target.matches('.remainInp') || e.target.matches('.springInp'))){
          renderRoundPreview();
        }
      });

      // 春天勾选/选择
      document.addEventListener('change', (e)=>{
        if(e.target && (e.target.matches('.springChk') || e.target.matches('.springSelect'))){
          renderRoundPreview();
        }
      });

      // 赢家切换（winnerQuick 区域的按钮）
      const winnerQuick = document.getElementById('winnerQuick');
      if(winnerQuick){
        winnerQuick.addEventListener('click', (e)=>{
          const btn = e.target && e.target.closest('.winnerBtn');
          if(btn){
            requestAnimationFrame(renderRoundPreview);
          }
        });
      }

      // 炸弹变动
      ['bombDec','bombInc','bombReset'].forEach(id=>{
        const btn = document.getElementById(id);
        if(btn) btn.addEventListener('click', ()=> requestAnimationFrame(renderRoundPreview));
      });

      // 模式切换：仅在 remain 模式下展示/刷新
      const modeSel = document.getElementById('mode');
      if(modeSel){
        modeSel.addEventListener('change', ()=>{
          if(modeSel.value === 'remain'){
            ensurePreviewCells();
            renderRoundPreview();
          }
        });
      }
    }

    // DOM 就绪后绑定（defer 脚本：此刻 DOM 已解析）
    bindLiveRefresh();
    // 暴露一个全局钩子，若你在 app.js 渲染结束时愿意手动调用也行
    window.__refreshRoundPreview = function(){
      ensurePreviewCells();
      renderRoundPreview();
    };
  })();
  </script>

  <!-- 注册 Service Worker（HTTPS 或 localhost 生效） -->
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
  </script>
</body>
</html>





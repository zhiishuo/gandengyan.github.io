<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>å¹²çªçœ¼ Â· è®°åˆ†æ¿ Â· DiamantÃ©</title>

<!-- PWA åŸºæœ¬é…ç½® -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0e1116">

<!-- iOS PWA å…ƒæ ‡ç­¾ -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="è®°åˆ†æ¿">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="stylesheet" href="style.css">

<!-- é¢„è§ˆåˆ—æ ·å¼ï¼ˆæ­£ç»¿/è´Ÿçº¢/é›¶ç°ï¼‰ -->
<style>
  .previewCell{ text-align:right; }
  .previewVal{ font-weight:800; letter-spacing:.2px; }
  .previewVal.pos{ color:#16a34a; }   /* æ­£æ•°ï¼šç»¿ */
  .previewVal.neg{ color:#f87171; }   /* è´Ÿæ•°ï¼šçº¢ */
  .previewVal.zero{ color:#cbd5e1; }  /* 0ï¼šç° */
</style>
</head>
<body>

  <div class="viewport">
    <div class="pages" id="pages">
      <!-- Page 0: ç©å®¶ -->
      <section class="page" data-page="players">
        <div class="panel">
          <h2>ç©å®¶è®¾ç½®</h2>
          <div class="flex">
            <span class="pill">äººæ•°ï¼š<b id="playerCountEcho">7</b></span>
            <button class="btn" id="minusP">ï¼1</button>
            <button class="btn" id="plusP">ï¼‹1</button>
          </div>
          <div class="flex" style="margin-top:8px">
            <label>è®¾ä¸ºï¼š<input id="setP" class="mono num" value="7"></label>
            <button class="btn accent" id="applyP">åº”ç”¨äººæ•°</button>
          </div>
          <table style="margin-top:8px">
            <thead><tr><th>#</th><th>ç©å®¶å</th><th>åˆ†</th></tr></thead>
            <tbody id="playersBody"></tbody>
          </table>
          <div class="flex" style="margin-top:8px">
            <button class="btn accent" id="resetNames">é‡ç½®åå­—</button>
            <button class="btn" id="zeroScores">åˆ†æ•°æ¸…é›¶</button>
          </div>
        </div>
      </section>

      <!-- Page 1: è®°åˆ† -->
      <section class="page" data-page="score">
        <div class="panel">
          <!-- çº¢è‰²ç‚¸å¼¹å¡ï¼ˆä»…åŠ /å‡/é‡ç½®ï¼‰ -->
          <div class="bombCard" id="bombCard">
            <div class="bombValue mono" id="bombValue">ğŸ’£ ç‚¸å¼¹ 0 ï½œ å€æ•° Ã—1</div>
            <div class="bombBtns">
              <button class="btn" id="bombDec">ï¼</button>
              <button class="btn" id="bombInc">ï¼‹</button>
              <button class="btn" id="bombReset">é‡ç½®</button>
            </div>
          </div>

          <!-- æ¨¡å¼é€‰æ‹©ï¼ˆèµ¢å®¶åªé€šè¿‡ä¸‹æ–¹æŒ‰é’®é€‰æ‹©ï¼‰ -->
          <div class="flex" style="margin-top:12px">
            <label>æ¨¡å¼
              <select id="mode">
                <option value="remain" selected>å‰©ç‰Œç»“ç®—</option>
                <option value="winner1">èƒœè€… +1</option>
                <option value="manual">æ‰‹å·¥è¾“å…¥</option>
              </select>
            </label>
          </div>

          <!-- èµ¢å®¶ï¼šç‚¹åå­—é€‰æ‹©ï¼ˆç”¨äº remain å¿«é€Ÿåˆ‡æ¢èµ¢å®¶ï¼‰ -->
          <div class="flex" id="winnerQuick" style="margin-top:8px"></div>

          <!-- å‰©ç‰Œ / æ˜¥å¤©ï¼ˆæ¯è¡Œæ˜¥å¤©=å•æŒ‰é’®ï¼‰ -->
          <div id="modeRemain" style="margin-top:8px">
            <table>
              <thead><tr><th>#</th><th>ç©å®¶</th><th>å‰©ç‰Œ</th><th>æ˜¥å¤©</th><th>é¢„è§ˆ</th></tr></thead>
              <tbody id="remainBody"></tbody>
            </table>
          </div>

          <!-- èƒœè€…+1ï¼šåœ¨ winner1 æ¨¡å¼ä¸‹æ˜¾ç¤º -->
          <div id="modeWinner1" style="display:none; margin-top:8px">
            <div class="muted">ç‚¹é€‰æœ¬è½®èƒœè€…ï¼š</div>
            <div id="winnerList" class="flex" style="gap:8px; flex-wrap:wrap; margin-top:6px"></div>
          </div>

          <!-- æ‰‹å·¥è¾“å…¥ -->
          <div id="modeManual" style="display:none; margin-top:8px">
            <table>
              <thead><tr><th>#</th><th>ç©å®¶</th><th>åˆ†</th></tr></thead>
              <tbody id="manualBody"></tbody>
            </table>
          </div>

          <!-- é¢„è§ˆ + å…¥è´¦ï¼ˆä¿ç•™ï¼Œä½œä¸ºå¯¹ç…§/æç¤ºç”¨ï¼‰ -->
          <div class="panel" style="margin-top:10px">
            <div class="flex" style="justify-content:space-between">
              <span class="muted">æœ¬è½®é¢„è§ˆï¼ˆå«å€æ•°/æ˜¥å¤©ï¼‰</span>
              <span class="pill">ä»…é¢„è§ˆ</span>
            </div>
            <div id="previewBox" class="mono" style="margin-top:6px; color:#fff5f5">â€”</div>
            <div id="winnerPot" class="mono" style="margin-top:6px; color:#ffdede"></div>
            <div class="flex" style="margin-top:10px; justify-content:flex-end"></div>
          </div>
        </div>
      </section>

      <!-- Page 2: å®æ—¶æ’å -->
      <section class="page" data-page="rank">
        <div class="panel">
          <div class="rankHeader">
            <h2>å®æ—¶æ’å</h2>
            <div class="sub" id="rankMeta">â€”</div>
          </div>
          <div class="rankList" id="rankList"></div>
        </div>
      </section>

      <!-- Page 3: å†å² -->
      <section class="page" data-page="history">
        <div class="panel">
          <h2>å›åˆå†å²</h2>
          <table>
            <thead><tr><th>#</th><th>æ˜ç»†</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="historyBody"></tbody>
          </table>
          <div class="flex" style="margin-top:8px">
            <button class="btn warn" id="clearHistory">æ¸…ç©ºå†å²</button>
            <button class="btn" id="exportCsv">å¯¼å‡º CSV</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- è®°åˆ†é¡µä¸“å±ï¼šåœé å°è®¡æ¡ -->
  <div class="subtotalDock" id="subtotalDock" aria-live="polite">
    <div class="dockInner">
      <div>å½“å‰å€æ•°ï¼š<b class="mono" id="dockMult">Ã—1</b></div>
      <div>èµ¢å®¶é¢„è®¡è¿›è´¦ï¼š<b class="mono" id="dockPot">+0</b></div>
      <!-- å°è®¡æ¡å†… -->
      <div class="dockActions" role="group" aria-label="å…¥è´¦ä¸æ’¤é”€">
        <button id="commit_m" class="gbtn primary" type="button">
          <span class="gbtn-ico">âœ”</span><span>å…¥è´¦</span>
        </button>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨ Tab -->
  <nav class="tabbar">
    <button class="tabbtn" data-tab="players" aria-label="ç©å®¶">
      <span class="ico" aria-hidden="true">
        <!-- People / Players -->
        <svg viewBox="0 0 24 24" width="24" height="24">
          <circle cx="8" cy="8" r="3"></circle>
          <circle cx="16" cy="9" r="2.5"></circle>
          <path d="M3 19c0-3 3-5 6-5s6 2 6 5"></path>
          <path d="M13.5 14.5c2.4.4 4.5 2 4.5 4.5"></path>
        </svg>
      </span>
      ç©å®¶
    </button>

    <button class="tabbtn active" data-tab="score" aria-label="è®°åˆ†">
      <span class="ico" aria-hidden="true">
        <!-- Clipboard / Score -->
        <svg viewBox="0 0 24 24" width="24" height="24">
          <rect x="5" y="5" width="14" height="15" rx="2"></rect>
          <path d="M9 5h6v3H9z"></path>
          <path d="M8 12h8M8 16h8"></path>
        </svg>
      </span>
      è®°åˆ†
    </button>

    <button class="tabbtn" data-tab="rank" aria-label="æ’å">
      <span class="ico" aria-hidden="true">
        <!-- Trophy / Rank -->
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path d="M8 4h8v2a4 4 0 0 1-8 0V4z"></path>
          <path d="M4 6h4a5 5 0 0 1-5 5V8a2 2 0 0 1 1-2z"></path>
          <path d="M20 6h-4a5 5 0 0 0 5 5V8a2 2 0 0 0-1-2z"></path>
          <path d="M10 15h4v4h-4z"></path>
          <path d="M8 19h8"></path>
        </svg>
      </span>
      æ’å
    </button>

    <button class="tabbtn" data-tab="history" aria-label="å†å²">
      <span class="ico" aria-hidden="true">
        <!-- Clock / History -->
        <svg viewBox="0 0 24 24" width="24" height="24">
          <circle cx="12" cy="12" r="8"></circle>
          <path d="M12 8v5l3 2"></path>
        </svg>
      </span>
      å†å²
    </button>
  </nav>

  <!-- å…¥è´¦æˆåŠŸæé†’ -->
  <div class="toast" id="toast">âœ… å…¥è´¦æˆåŠŸ</div>

  <!-- ä½ çš„ä¸»é€»è¾‘ -->
  <script src="app.js" defer></script>

  <!-- é¢„è§ˆåˆ—æ³¨å…¥ä¸è®¡ç®—ï¼ˆä¾èµ– app.js ä¸­çš„ state / roundDraftï¼‰ -->
  <script defer>
  (function(){
    // å®‰å…¨å–æ•°
    function num(x){ x = Number(x); return isFinite(x) ? x : 0; }

    // ç»™ #remainBody çš„æ¯ä¸€è¡Œè¡¥ä¸Šâ€œé¢„è§ˆâ€å•å…ƒæ ¼ï¼š<td class="previewCell"><span class="previewVal mono zero" data-idx="i">+0</span></td>
    function ensurePreviewCells(){
      const tbody = document.getElementById('remainBody');
      if(!tbody) return;
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.forEach((tr, i) => {
        // å¦‚æœå·²æœ‰ previewCellï¼Œå°±åªæ›´æ–° data-idx
        let cell = tr.querySelector('.previewCell');
        if(!cell){
          cell = document.createElement('td');
          cell.className = 'previewCell';
          const span = document.createElement('span');
          span.className = 'previewVal mono zero';
          span.dataset.idx = String(i);
          span.textContent = '+0';
          cell.appendChild(span);
          tr.appendChild(cell);
        }else{
          const span = cell.querySelector('.previewVal');
          if(span) span.dataset.idx = String(i);
        }
      });
    }

    // è®¡ç®—å¹¶æ¸²æŸ“â€œæœ¬è½®é¢„è§ˆâ€
    function renderRoundPreview(){
      try{
        const N = (window.state && Array.isArray(state.players)) ? state.players.length : 0;
        if(!N) return;

        const w = num(window.state && state.remainWinner);
        const mult = Math.pow(2, Math.max(0, num(window.state && state.bombCount)));

        // åˆå§‹åŒ–
        document.querySelectorAll('.previewVal').forEach(el=>{
          el.textContent = '+0';
          el.classList.remove('pos','neg','zero');
          el.classList.add('zero');
        });

        if(!(w >= 0 && w < N)) return; // æœªé€‰æ‹©èµ¢å®¶

        let winnerGain = 0;

        for(let i=0;i<N;i++){
          const remain = num(window.roundDraft && roundDraft.remain && roundDraft.remain[i]);
          const spring = !!(window.roundDraft && roundDraft.springs && roundDraft.springs[i]);
          const cell = document.querySelector(`.previewVal[data-idx="${i}"]`);
          if(!cell) continue;

          if(i === w){
            cell.textContent = '+0';
            cell.classList.remove('pos','neg','zero');
            cell.classList.add('zero');
          }else{
            let base = remain;
            if(spring) base *= 2;       // æ˜¥å¤©ç¿»å€
            const lose = base * mult;   // ä¹˜ç‚¸å¼¹å€æ•°
            const val = -lose;          // è¾“å®¶ä¸ºè´Ÿ

            winnerGain += lose;

            cell.textContent = (val >= 0 ? '+' : '') + String(val);
            cell.classList.remove('pos','neg','zero');
            cell.classList.add(val > 0 ? 'pos' : (val < 0 ? 'neg' : 'zero'));
          }
        }

        const wcell = document.querySelector(`.previewVal[data-idx="${w}"]`);
        if(wcell){
          wcell.textContent = '+' + String(winnerGain);
          wcell.classList.remove('pos','neg','zero');
          wcell.classList.add(winnerGain > 0 ? 'pos' : (winnerGain < 0 ? 'neg' : 'zero'));
        }

        // åŒæ­¥åº•éƒ¨å°è®¡æ¡çš„èµ¢å®¶è¿›è´¦ï¼ˆè‹¥éœ€è¦ï¼‰
        const dockPot = document.getElementById('dockPot');
        if(dockPot){
          dockPot.textContent = '+' + String(winnerGain);
        }
      }catch(e){
        // console.debug('renderRoundPreview error', e);
      }
    }

    // ç›‘å¬ DOM å˜åŒ–ï¼ˆå½“ app.js é‡æ–°æ¸²æŸ“ #remainBody æ—¶ï¼Œè‡ªåŠ¨è¡¥åˆ—å¹¶åˆ·æ–°ï¼‰
    const remainBody = document.getElementById('remainBody');
    if(remainBody){
      const mo = new MutationObserver(()=>{
        ensurePreviewCells();
        // ç­‰æ¸²æŸ“ç¨³å®šä¸€å¸§å†ç®—ï¼Œé¿å…å–ä¸å…¨
        requestAnimationFrame(renderRoundPreview);
      });
      mo.observe(remainBody, {childList:true, subtree:true, characterData:true});
    }

    // å…³é”®äº¤äº’ååˆ·æ–°
    function bindLiveRefresh(){
      // åˆå§‹
      ensurePreviewCells();
      renderRoundPreview();

      // å‰©ç‰Œè¾“å…¥/æ˜¥å¤©è¾“å…¥
      document.addEventListener('input', (e)=>{
        if(e.target && (e.target.matches('.remainInp') || e.target.matches('.springInp'))){
          renderRoundPreview();
        }
      });

      // æ˜¥å¤©å‹¾é€‰/é€‰æ‹©
      document.addEventListener('change', (e)=>{
        if(e.target && (e.target.matches('.springChk') || e.target.matches('.springSelect'))){
          renderRoundPreview();
        }
      });

      // èµ¢å®¶åˆ‡æ¢ï¼ˆwinnerQuick åŒºåŸŸçš„æŒ‰é’®ï¼‰
      const winnerQuick = document.getElementById('winnerQuick');
      if(winnerQuick){
        winnerQuick.addEventListener('click', (e)=>{
          const btn = e.target && e.target.closest('.winnerBtn');
          if(btn){
            requestAnimationFrame(renderRoundPreview);
          }
        });
      }

      // ç‚¸å¼¹å˜åŠ¨
      ['bombDec','bombInc','bombReset'].forEach(id=>{
        const btn = document.getElementById(id);
        if(btn) btn.addEventListener('click', ()=> requestAnimationFrame(renderRoundPreview));
      });

      // æ¨¡å¼åˆ‡æ¢ï¼šä»…åœ¨ remain æ¨¡å¼ä¸‹å±•ç¤º/åˆ·æ–°
      const modeSel = document.getElementById('mode');
      if(modeSel){
        modeSel.addEventListener('change', ()=>{
          if(modeSel.value === 'remain'){
            ensurePreviewCells();
            renderRoundPreview();
          }
        });
      }
    }

    // DOM å°±ç»ªåç»‘å®šï¼ˆdefer è„šæœ¬ï¼šæ­¤åˆ» DOM å·²è§£æï¼‰
    bindLiveRefresh();
    // æš´éœ²ä¸€ä¸ªå…¨å±€é’©å­ï¼Œè‹¥ä½ åœ¨ app.js æ¸²æŸ“ç»“æŸæ—¶æ„¿æ„æ‰‹åŠ¨è°ƒç”¨ä¹Ÿè¡Œ
    window.__refreshRoundPreview = function(){
      ensurePreviewCells();
      renderRoundPreview();
    };
  })();
  </script>

  <!-- æ³¨å†Œ Service Workerï¼ˆHTTPS æˆ– localhost ç”Ÿæ•ˆï¼‰ -->
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
  </script>
</body>
</html>





<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>å¹²çªçœ¼ Â· è®°åˆ†æ¿ Â· DiamantÃ©</title>
<style>
  /* ================= DiamantÃ© Â· ä¸»é¢˜å˜é‡ï¼ˆä¸­æ€§/çŸ³å¢¨ï¼‰ ================= */
  :root{
    --bg:#0e1116; --bg2:#151a22;
    --panel:#141b25e6;
    --ink:#f5f7fa; --muted:#c4cbd6;
    --line:rgba(206,212,224,.25);

    --accent:#27c268; --accent-deep:#165a36;
    --warn:#ef4444; --info:#58c7f3;

    --shadow:0 10px 28px rgba(0,0,0,.22);
    --radius:16px;
    --trans-fast:.18s cubic-bezier(.22,.61,.36,1);
    --trans-slow:.35s cubic-bezier(.22,.61,.36,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Inter,Helvetica,Arial;
    background:
      radial-gradient(1200px 800px at 20% -10%, #1c243244, transparent),
      radial-gradient(900px 700px at 110% 10%, #15212e33, transparent),
      linear-gradient(180deg,var(--bg),var(--bg2));
  }

  /* ===== é¡¶éƒ¨æ  ===== */
  header{
    position:sticky; top:0; z-index:50;
    padding:12px 14px;
    border-bottom:1px solid var(--line);
    backdrop-filter:blur(12px);
    background:#111722cc;
  }
  .titleRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  h1{ margin:0; font-size:18px; letter-spacing:.3px }
  .badgeMini{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border:1px solid var(--line);
    border-radius:999px; background:#0f1520; font-size:12px;
  }
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}

  /* ===== è§†å£ + æ¨ªå‘é¡µé¢å®¹å™¨ï¼ˆä»…ç‚¹å‡»åˆ‡æ¢ï¼Œæ— æ‰‹åŠ¿ï¼‰ ===== */
  .viewport{
    position:relative;
    height:calc(100svh - 56px - 64px);
  }
  @supports not (height: 100svh){
    .viewport{ height:calc(100vh - 56px - 64px); }
  }
  .pages{
    height:100%;
    display:flex;
    transform:translate3d(0,0,0);
    transition:transform var(--trans-slow);
    touch-action:pan-y; /* ç¦æ­¢æ¨ªå‘æ»‘åŠ¨åˆ‡é¡µï¼Œä»…å…è®¸çºµå‘æ»šåŠ¨ */
  }
  .page{
    flex:0 0 100%;
    padding:12px 12px calc(72px + env(safe-area-inset-bottom));
    overflow:auto; -webkit-overflow-scrolling:touch;
  }

  /* ===== é¢æ¿ä¸é€šç”¨ ===== */
  .panel{
    background:var(--panel);
    border:1px solid rgba(206,212,224,.22);
    border-radius:var(--radius);
    padding:12px; box-shadow:var(--shadow);
  }
  .panel h2{margin:6px 0 10px; font-size:16px}
  .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .pill{font-size:14px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#101723}
  input,select,button{
    border-radius:12px; border:1px solid rgba(206,212,224,.22); background:#101723; color:var(--ink);
    padding:12px 14px; font-size:16px
  }
  button{cursor:pointer; min-height:44px; transition:transform var(--trans-fast),box-shadow var(--trans-fast)}
  button:active{transform:scale(.98)}
  .btn{padding:12px 16px}
  .btn.accent{background:#123422; border-color:#1f6b46; color:#defbe6}
  .btn.warn{background:#3a1212; border-color:#6a1d1d; color:#ffd5d5}
  .muted{color:var(--muted); font-size:14px}
  table{width:100%; border-collapse:collapse; font-size:16px}
  th,td{border-bottom:1px dashed var(--line); padding:10px 6px; text-align:center}
  th{color:#e8edf6; font-weight:600}
  .name{width:160px}
  .num{width:90px; text-align:right}
  input:focus,select:focus,button:focus{outline:2px solid #3b82f6; outline-offset:2px}

  /* ===== åº•éƒ¨ Tab ===== */
  .tabbar{
    position:fixed; left:0; right:0; bottom:0; z-index:60;
    display:flex; justify-content:space-around; gap:4px;
    padding:8px 8px calc(8px + env(safe-area-inset-bottom));
    border-top:1px solid var(--line);
    background:#111722f2; backdrop-filter:blur(10px);
  }
  .tabbtn{
    flex:1; display:flex; flex-direction:column; align-items:center; gap:4px;
    padding:8px; border-radius:12px; border:1px solid transparent;
    color:#e8eefb; font-size:12px; min-width:0;
    transition:background var(--trans-fast), border-color var(--trans-fast), color var(--trans-fast);
  }
  .tabbtn .ico{font-size:18px; line-height:1}
  .tabbtn.active{border-color:#445268; background:#0e1522; color:#ffffff}

  /* ===== è®°åˆ†ï¼šçº¢è‰²ç‚¸å¼¹ä¸»é¢˜ ===== */
  .bombCard{
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px;
    border-radius:14px;
    background:linear-gradient(180deg,#3a0f14,#22090c);
    border:1px solid rgba(255,99,99,.35);
    padding:18px 12px; text-align:center;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.04), 0 6px 20px rgba(120,20,20,.25);
  }
  .bombLabel{ font-size:13px; color:#ffd7d7; letter-spacing:.2px; display:flex; align-items:center; gap:6px; }
  .bombLabel::before{content:"ğŸ’£";}
  .bombValue{ font-weight:800; font-size:30px; letter-spacing:.6px; line-height:1.06; color:#fff3f3 }
  .bombBtns{ display:flex; gap:10px; }
  .bombBtns .btn{
    min-width:84px; min-height:50px; font-size:18px; font-weight:800;
    border-radius:14px;
  }
  .bombBtns .btn#bombDec, .bombBtns .btn#bombInc{
    background:#2a0e12; border-color:#7a2d2d; color:#ffe2e2;
  }
  .bombBtns .btn#bombReset{
    background:#3a1212; border-color:#a33a3a; color:#ffdada;
  }
  .bombPulse{animation:pop .22s cubic-bezier(.2,.8,.2,1)}
  @keyframes pop{0%{transform:scale(.96)}100%{transform:scale(1)}}

  /* ===== è®°åˆ†ï¼šåœé å°è®¡æ¡ï¼ˆä»…è®°åˆ†é¡µæ˜¾ç¤ºï¼‰ ===== */
  .subtotalDock{
    position:fixed; left:10px; right:10px;
    bottom: calc(64px + env(safe-area-inset-bottom));
    z-index:59;
    opacity:0; transform:translateY(8px);
    pointer-events:none;
    transition:opacity .25s cubic-bezier(.22,.61,.36,1), transform .25s cubic-bezier(.22,.61,.36,1);
  }
  .subtotalDock.show{ opacity:1; transform:translateY(0); }
  .subtotalDock .dockInner{
    display:flex; justify-content:space-between; align-items:center; gap:12px;
    padding:10px 12px; border:1px solid var(--line); border-radius:12px;
    background:#0f1520f2; backdrop-filter:blur(8px); box-shadow:var(--shadow);
  }

  /* ===== æç¤ºæ¡ï¼ˆå…¥è´¦æˆåŠŸï¼‰ ===== */
  .toast{
    position:fixed; left:50%; bottom:88px; transform:translateX(-50%) translateY(20px);
    background:#0f2b1b; border:1px solid #1b5e38; color:#caffdd;
    padding:10px 14px; border-radius:999px; box-shadow:var(--shadow);
    opacity:0; pointer-events:none; transition:opacity var(--trans-slow), transform var(--trans-slow);
    z-index:70;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  /* ===== å®æ—¶æ’åï¼ˆå¡ç‰‡å¼ + å¼ºåŒ–åˆ†æ•°èƒ¶å›Šï¼‰ ===== */
  .rankHeader{ text-align:center; margin:4px 0 10px 0; }
  .rankHeader h2{ margin:0; font-size:17px; letter-spacing:.4px; }
  .rankHeader .sub{ margin-top:4px; font-size:12px; color:var(--muted); }
  .rankList{ display:flex; flex-direction:column; gap:6px; }
  .rankCard{
    display:grid; grid-template-columns:56px 1fr auto; gap:10px; align-items:center;
    padding:10px 12px; border:1px solid var(--line); border-radius:14px; background:#0f1520aa;
  }
  .rankNo{
    width:36px; height:36px; border-radius:10px; display:grid; place-items:center;
    font-weight:800; font-size:16px; color:#0e1116; background:#e7eaf1;
  }
  .rankNo.gold{ background:linear-gradient(135deg,#ffd76a,#f4b400,#d9a400); color:#3a2a09 }
  .rankNo.silver{ background:linear-gradient(135deg,#f0f3f8,#cfd6de,#b9c2cc); color:#2e3135 }
  .rankNo.bronze{ background:linear-gradient(135deg,#f2c7a1,#d99159,#a56438); color:#2f1d0f }
  .rankName{ font-size:16px }
  .rankScore{
    justify-self:end;
    font-family:ui-monospace,Menlo,Consolas,monospace;
    font-size:20px; font-weight:800;
    padding:6px 10px; border-radius:12px;
    background:#0f1520; border:1px solid var(--line);
    letter-spacing:.2px; display:inline-flex; align-items:baseline; gap:4px;
  }
  .rankScore .unit{ font-size:12px; opacity:.7 }
  .rankCard.top .rankScore{ box-shadow:0 4px 16px rgba(0,0,0,.25); background:linear-gradient(180deg,#101826,#0c121c); }
  .rankCard.pos .rankScore{ color:#16a34a }
  .rankCard.neg .rankScore{ color:#f87171 }
  .rankCard.zero .rankScore{ color:#e5e7eb }

  /* æ— éšœç¢ï¼šå‡å°‘åŠ¨æ€æ—¶å¼±åŒ–åŠ¨ç”» */
  @media (prefers-reduced-motion: reduce){
    *{animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important;}
  }
</style>
</head>
<body>
  <header>
    <div class="titleRow">
      <h1>å¹²çªçœ¼ Â· è®°åˆ†æ¿</h1>
      <span class="badgeMini">ğŸ’£ <span class="mono" id="badgeMini">ç‚¸å¼¹ 0 ï½œ å€æ•° Ã—1</span></span>
    </div>
  </header>

  <div class="viewport">
    <div class="pages" id="pages">
      <!-- Page 0: ç©å®¶ -->
      <section class="page" data-page="players">
        <div class="panel">
          <h2>ç©å®¶è®¾ç½®</h2>
          <div class="flex">
            <span class="pill">äººæ•°ï¼š<b id="playerCountEcho">7</b></span>
            <button class="btn" id="minusP">ï¼1</button>
            <button class="btn" id="plusP">ï¼‹1</button>
          </div>
          <div class="flex" style="margin-top:8px">
            <label>è®¾ä¸ºï¼š<input id="setP" class="mono num" value="7"></label>
            <button class="btn accent" id="applyP">åº”ç”¨äººæ•°</button>
          </div>
          <table style="margin-top:8px">
            <thead><tr><th>#</th><th>ç©å®¶å</th><th>åˆ†</th></tr></thead>
            <tbody id="playersBody"></tbody>
          </table>
          <div class="flex" style="margin-top:8px">
            <button class="btn accent" id="resetNames">é‡ç½®åå­—</button>
            <button class="btn" id="zeroScores">åˆ†æ•°æ¸…é›¶</button>
          </div>
        </div>
      </section>

      <!-- Page 1: è®°åˆ†ï¼ˆçº¢è‰²ç‚¸å¼¹ + æ˜¥å¤©æŒ‰é’®åœ¨åˆ—ä¸‹æ–¹å•ç²’ï¼‰ -->
      <section class="page" data-page="score">
        <div class="panel">
          <!-- ç‚¸å¼¹æ¨¡å—ï¼ˆå»æ‰æ•°å­—è¾“å…¥ï¼Œåªç•™å‡/åŠ /æ¸…é›¶ï¼‰ -->
          <div class="bombCard" id="bombCard">
            <div class="bombLabel">ç‚¸å¼¹ä¸å€æ•°</div>
            <div class="bombValue mono" id="bombValue">ç‚¸å¼¹ 0 ï½œ å€æ•° Ã—1</div>
            <div class="bombBtns">
              <button class="btn" id="bombDec">ï¼</button>
              <button class="btn" id="bombInc">ï¼‹</button>
              <button class="btn" id="bombReset">é‡ç½®</button>
            </div>
          </div>

          <!-- æ¨¡å¼/èµ¢å®¶é€‰æ‹© -->
          <div class="flex" style="margin-top:12px">
            <label>æ¨¡å¼
              <select id="mode">
                <option value="remain" selected>å‰©ç‰Œç»“ç®—</option>
                <option value="winner1">èƒœè€… +1</option>
                <option value="manual">æ‰‹å·¥è¾“å…¥</option>
              </select>
            </label>
            <span class="pill">èµ¢å®¶ï¼š</span>
            <select id="remainWinner" class="winnerSelect" style="min-width:180px"></select>
          </div>

          <!-- å¿«æ·èµ¢å®¶æŒ‰é’® -->
          <div class="flex" id="winnerQuick" style="margin-top:8px"></div>

          <!-- å‰©ç‰Œ / æ˜¥å¤©ï¼ˆæ¯è¡Œæ˜¥å¤©åˆ—åªä¿ç•™ä¸€ä¸ªæŒ‰é’®ï¼‰ -->
          <div id="modeRemain" style="margin-top:8px">
            <table>
              <thead><tr><th>#</th><th>ç©å®¶</th><th>å‰©ç‰Œ</th><th>æ˜¥å¤©</th></tr></thead>
              <tbody id="remainBody"></tbody>
            </table>
          </div>

          <!-- èƒœè€…+1 / æ‰‹å·¥è¾“å…¥ -->
          <div id="modeWinner1" style="display:none; margin-top:8px">
            <div class="muted">ç‚¹é€‰æœ¬è½®èƒœè€…ï¼š</div>
            <div id="winnerList" class="flex" style="gap:8px; flex-wrap:wrap; margin-top:6px"></div>
          </div>
          <div id="modeManual" style="display:none; margin-top:8px">
            <table>
              <thead><tr><th>#</th><th>ç©å®¶</th><th>åˆ†</th></tr></thead>
              <tbody id="manualBody"></tbody>
            </table>
          </div>

          <!-- é¢„è§ˆ + å…¥è´¦ï¼ˆç´§è·Ÿæ˜¥å¤©åŒºåŸŸä¸‹æ–¹ï¼‰ -->
          <div class="panel" style="margin-top:10px">
            <div class="flex" style="justify-content:space-between">
              <span class="muted">æœ¬è½®é¢„è§ˆï¼ˆå«å€æ•°/æ˜¥å¤©ï¼‰</span>
              <span class="pill">ä»…é¢„è§ˆ</span>
            </div>
            <div id="previewBox" class="mono" style="margin-top:6px; color:#fff5f5">â€”</div>
            <div id="winnerPot" class="mono" style="margin-top:6px; color:#ffdede"></div>

            <div class="flex" style="margin-top:10px; justify-content:flex-end">
              <button class="btn" id="undo">æ’¤é”€</button>
              <button class="btn accent" id="commit_m">å…¥è´¦</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Page 2: å®æ—¶æ’å -->
      <section class="page" data-page="rank">
        <div class="panel">
          <div class="rankHeader">
            <h2>å®æ—¶æ’å</h2>
            <div class="sub" id="rankMeta">â€”</div>
          </div>
          <div class="rankList" id="rankList"></div>
        </div>
      </section>

      <!-- Page 3: å†å² -->
      <section class="page" data-page="history">
        <div class="panel">
          <h2>å›åˆå†å²</h2>
          <table>
            <thead><tr><th>#</th><th>æ˜ç»†</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="historyBody"></tbody>
          </table>
          <div class="flex" style="margin-top:8px">
            <button class="btn warn" id="clearHistory">æ¸…ç©ºå†å²</button>
            <button class="btn" id="exportCsv">å¯¼å‡º CSV</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- è®°åˆ†é¡µä¸“å±ï¼šåœé å°è®¡æ¡ -->
  <div class="subtotalDock" id="subtotalDock" aria-live="polite">
    <div class="dockInner">
      <div>å½“å‰å€æ•°ï¼š<b class="mono" id="dockMult">Ã—1</b></div>
      <div>èµ¢å®¶é¢„è®¡è¿›è´¦ï¼š<b class="mono" id="dockPot">+0</b></div>
    </div>
  </div>

  <!-- åº•éƒ¨ Tab -->
  <nav class="tabbar">
    <button class="tabbtn" data-tab="players"><div class="ico">ğŸ‘¥</div>ç©å®¶</button>
    <button class="tabbtn active" data-tab="score"><div class="ico">ğŸ“</div>è®°åˆ†</button>
    <button class="tabbtn" data-tab="rank"><div class="ico">ğŸ†</div>æ’å</button>
    <button class="tabbtn" data-tab="history"><div class="ico">ğŸ—‚ï¸</div>å†å²</button>
  </nav>

  <!-- å…¥è´¦æˆåŠŸæé†’ -->
  <div class="toast" id="toast">âœ… å…¥è´¦æˆåŠŸ</div>

<script>
/* ================== çŠ¶æ€ ================== */
const LS_KEY="gandengyan_scoreboard_mobile_full_v2_spring";
let state = {
  players: Array.from({length:7}, (_,i)=>({name:"ç©å®¶"+(i+1), score:0})),
  history: [],
  bombCount: 0,
  remainWinner: 0,
};
function N(){return state.players.length;}
function save(){localStorage.setItem(LS_KEY, JSON.stringify(state));}
function load(){const s=localStorage.getItem(LS_KEY); if(s){try{state=JSON.parse(s)}catch{}}}
function mult(){return Math.pow(2, Math.max(0, +state.bombCount||0));}

/* ================== è§†å›¾åˆ‡æ¢ï¼ˆä»…ç‚¹å‡»ï¼Œæ— æ»‘æ‰‹åŠ¿ï¼‰ ================== */
const pagesEl = document.getElementById('pages');
const tabs = [...document.querySelectorAll('.tabbtn')];
const pageIndex = { players:0, score:1, rank:2, history:3 };
let current = 1; // é»˜è®¤â€œè®°åˆ†â€
function go(tab){
  const idx = pageIndex[tab] ?? 1;
  current = idx;
  pagesEl.style.transform = `translate3d(${-100*idx}%,0,0)`;
  tabs.forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));

  // ä»…è®°åˆ†é¡µæ˜¾ç¤ºå°è®¡æ¡
  const dock = document.getElementById('subtotalDock');
  if (dock) dock.classList.toggle('show', tab === 'score');

  stickDockToTab();
}
tabs.forEach(b=> b.addEventListener('click', ()=> go(b.dataset.tab)));

/* ================== å·¥å…· ================== */
function escapeHTML(s=''){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* ================== å…¬å…±æ¸²æŸ“ ================== */
function updateBombUI(){
  const m = mult();
  const text = `ç‚¸å¼¹ ${state.bombCount} ï½œ å€æ•° Ã—${m}`;
  const mini = document.getElementById('badgeMini');
  const bombValue = document.getElementById('bombValue');
  if(mini) mini.textContent = text;
  if(bombValue) bombValue.textContent = text;

  const dockMult = document.getElementById('dockMult');
  if(dockMult) dockMult.textContent = 'Ã—'+m;
}
function pulseBomb(){
  const card = document.getElementById('bombCard');
  if(!card) return;
  card.classList.remove('bombPulse'); void card.offsetWidth; card.classList.add('bombPulse');
}

/* ================== ç©å®¶ ================== */
function renderPlayers(){
  document.getElementById('playerCountEcho').textContent = String(N());
  document.getElementById('setP').value = String(N());
  const tb = document.getElementById('playersBody'); tb.innerHTML="";
  state.players.forEach((p,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td><input class="name" value="${escapeHTML(p.name)}" data-idx="${idx}"/></td><td class="mono">${p.score}</td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('input.name').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const i = +e.target.dataset.idx;
      state.players[i].name = e.target.value || ('ç©å®¶'+(i+1));
      save(); renderRemainArea(); renderQuickWinner(); renderRank(); recomputePreview();
    });
  });
  renderRank();
}

/* ================== è®°åˆ†é¡µï¼šèµ¢å®¶æŒ‰é’®/è¾“å…¥ ================== */
function renderQuickWinner(){
  const q = document.getElementById('winnerQuick'); q.innerHTML="";
  state.players.forEach((p,i)=>{
    const b = document.createElement('button');
    b.className = 'btn' + (i===state.remainWinner?' accent':'');
    b.textContent = p.name;
    b.addEventListener('click', ()=>{ state.remainWinner=i; save(); renderRemainArea(); renderQuickWinner(); recomputePreview(); });
    q.appendChild(b);
  });
}

/* --- æ˜¥å¤©ï¼šæŒ‰é’®åŒ–ï¼ˆæ¯è¡Œä¸€ä¸ªæŒ‰é’®ï¼‰ --- */
function renderRemainArea(){
  const sel = document.getElementById('remainWinner'); sel.innerHTML="";
  state.players.forEach((p,i)=>{
    const o=document.createElement('option'); o.value=i; o.textContent=p.name; sel.appendChild(o);
  });
  if (state.remainWinner>=N()) state.remainWinner=0;
  sel.value = String(state.remainWinner);
  sel.onchange = ()=>{ state.remainWinner=+sel.value; save(); renderRemainArea(); renderQuickWinner(); recomputePreview(); };

  const rb = document.getElementById('remainBody'); rb.innerHTML="";
  state.players.forEach((p,i)=>{
    const isW = (i===state.remainWinner);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHTML(p.name)}</td>
      <td>
        <input type="number" min="0" step="1" inputmode="numeric"
          class="num mono remainInp" data-idx="${i}" ${isW?'disabled':''}
          placeholder="${isW?'èµ¢å®¶=0':'å‰©ç‰Œæ•°'}">
      </td>
      <td>
        <button class="btn springBtn" data-idx="${i}" ${isW?'disabled':''}>æ˜¥å¤©</button>
      </td>`;
    rb.appendChild(tr);
  });
  rb.querySelectorAll('.remainInp').forEach(inp=> inp.addEventListener('input', recomputePreview));

  // æ˜¥å¤©æŒ‰é’®ç‚¹å‡»åˆ‡æ¢æ¿€æ´»æ€
  rb.querySelectorAll('.springBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(btn.disabled) return;
      btn.classList.toggle('accent');
      recomputePreview();
    });
  });

  const mb = document.getElementById('manualBody'); mb.innerHTML="";
  state.players.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHTML(p.name)}</td><td><input class="num mono manualInp" data-idx="${i}" placeholder="0"></td>`;
    mb.appendChild(tr);
  });
  mb.querySelectorAll('.manualInp').forEach(inp=> inp.addEventListener('input', recomputePreview));
}

/* ================== è®°åˆ†è®¡ç®—/é¢„è§ˆ/å…¥è´¦ ================== */
function switchMode(){
  const mode = document.getElementById('mode').value;
  document.getElementById('modeRemain').style.display = (mode==='remain')?'block':'none';
  document.getElementById('modeWinner1').style.display = (mode==='winner1')?'block':'none';
  document.getElementById('modeManual').style.display = (mode==='manual')?'block':'none';
  recomputePreview();
}

function computeRound(){
  const mode = document.getElementById('mode').value;
  const n = N(), m = mult();
  if (mode==='remain'){
    const w = state.remainWinner;
    const inputs = [...document.querySelectorAll('.remainInp')];
    const springBtns = [...document.querySelectorAll('.springBtn')];
    const remain = Array(n).fill(0), springMark = Array(n).fill(false);

    for (const inp of inputs){
      const i=+inp.dataset.idx; const raw=inp.value.trim();
      const v = raw===""?0:Number(raw);
      if (i===w) remain[i]=0;
      else{
        if(!Number.isFinite(v) || v<0 || Math.floor(v)!==v) return {error:"å‰©ç‰Œå¿…é¡»æ˜¯éè´Ÿæ•´æ•°"};
        remain[i]=v;
      }
    }
    for(const btn of springBtns){
      const i=+btn.dataset.idx;
      springMark[i] = btn.classList.contains('accent') && i!==w;
    }

    const delta = Array(n).fill(0); let pot=0;
    for(let i=0;i<n;i++){
      if(i===w) continue;
      const mul = springMark[i]?2:1;
      const loss = - remain[i]*m*mul;
      delta[i]=loss; pot += -loss;
    }
    delta[w]=pot;
    const remDesc = remain.map((v,i)=>`${state.players[i].name}:${v}${springMark[i]?'(æ˜¥)':''}`).join('ï¼Œ ');
    return {delta, desc:`å‰©ç‰Œç»“ç®— ï½œ èµ¢å®¶ï¼š${state.players[w].name} ï½œ å‰©ç‰Œï¼š[${remDesc}] Ã—${m}`, springs:springMark};
  }else if(mode==='winner1'){
    const sel = document.getElementById('winnerList').dataset.selected;
    if(sel===undefined) return {error:"è¯·é€‰æ‹©èƒœè€…"};
    const idx=+sel, delta=Array(n).fill(0); delta[idx]=1*m;
    return {delta, desc:`èƒœè€…ï¼š${state.players[idx].name}ï¼ˆ+1Ã—${m}ï¼‰`};
  }else{
    const inputs = [...document.querySelectorAll('.manualInp')];
    const delta = Array(n).fill(0);
    for(const inp of inputs){
      const i=+inp.dataset.idx; const raw=inp.value.trim(); const v=raw===""?0:Number(raw);
      if(!Number.isFinite(v)) return {error:"è¯·è¾“å…¥æ•°å­—"};
      delta[i]=v*m;
    }
    return {delta, desc:`æ‰‹å·¥è¾“å…¥ Ã—${m}`};
  }
}

function recomputePreview(){
  const res = computeRound();
  const box = document.getElementById('previewBox');
  const pot = document.getElementById('winnerPot');
  const dockPot = document.getElementById('dockPot');
  if(res?.error){
    box.textContent='â€” '+res.error;
    pot.textContent='';
    if(dockPot) dockPot.textContent='+0';
    return;
  }
  const signs = res.delta.map((v,i)=>`${state.players[i].name}:${v>=0?'+':''}${v}`);
  box.textContent = signs.join('ï¼Œ ');
  if (document.getElementById('mode').value==='remain'){
    const w = state.remainWinner;
    pot.textContent = `èµ¢å®¶ï¼ˆ${state.players[w].name}ï¼‰æœ¬è½®é¢„è®¡ï¼š+${res.delta[w]}`;
    if(dockPot) dockPot.textContent = `+${res.delta[w]}`;
  }else{
    pot.textContent='';
    if(dockPot) dockPot.textContent = '+0';
  }
}

function applyRound(delta, desc){
  const m = mult();
  state.players.forEach((p,i)=> p.score += (delta[i]||0));
  state.history.push({desc, delta, bombs: state.bombCount, mult: m});
  renderPlayers(); renderRemainArea(); renderQuickWinner(); renderRank(); renderHistory();
  save();
}

function commitRound(){
  const res = computeRound();
  if(res.error){ alert(res.error); return; }
  if(res.springs){
    const list = res.springs.map((v,i)=> v?state.players[i].name:null).filter(Boolean);
    if (list.length) res.desc += ` ï½œ æ˜¥å¤©ï¼š${list.join('ã€')}`;
  }
  applyRound(res.delta, res.desc);
  document.querySelectorAll('.remainInp').forEach(inp=>{ if(!inp.disabled) inp.value=""; });
  document.querySelectorAll('.springBtn').forEach(btn=>{ if(!btn.disabled) btn.classList.remove('accent'); });
  document.querySelectorAll('.manualInp').forEach(inp=> inp.value="");
  const wl=document.getElementById('winnerList'); if(wl) wl.dataset.selected="";
  recomputePreview();
  showToast('âœ… å…¥è´¦æˆåŠŸ');
}

/* ================== å†å² ================== */
function renderHistory(){
  const tb = document.getElementById('historyBody'); tb.innerHTML="";
  state.history.forEach((h,ri)=>{
    const tr = document.createElement('tr');
    const detail = h.delta.map((v,i)=>`${state.players[i]?.name||('ç©å®¶'+(i+1))}:${v>=0?'+':''}${v}`).join('ï¼Œ ');
    tr.innerHTML = `<td>${ri+1}</td>
      <td class="mono">${h.desc} ï½œ ç‚¸å¼¹:${h.bombs}ï¼ˆÃ—${h.mult}ï¼‰ ï½œ ${detail}</td>
      <td><button class="btn" data-del="${ri}">åˆ é™¤</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-del]').forEach(b=> b.addEventListener('click', ()=>deleteRound(+b.dataset.del)));
}
function deleteRound(idx){
  const h=state.history[idx]; if(!h) return;
  state.players.forEach((p,i)=> p.score -= (h.delta[i]||0));
  state.history.splice(idx,1);
  renderPlayers(); renderRemainArea(); renderQuickWinner(); renderRank(); renderHistory(); save();
  recomputePreview();
}
function clearHistory(){
  if(!state.history.length) return;
  if(!confirm('ç¡®å®šæ¸…ç©ºå†å²å¹¶å›æ»šåˆ†æ•°å—ï¼Ÿ')) return;
  for(const h of state.history){ state.players.forEach((p,i)=> p.score -= (h.delta[i]||0)); }
  state.history=[]; renderPlayers(); renderRemainArea(); renderQuickWinner(); renderRank(); renderHistory(); save();
  recomputePreview();
}
function exportCsv(){
  const header = ["Round", ...state.players.map(p=>p.name), "Bombs", "Multiplier", "Desc"];
  const rows=[header];
  state.history.forEach((h,ri)=> rows.push([ri+1, ...state.players.map((_,i)=> h.delta[i]||0), h.bombs, h.mult, h.desc]));
  rows.push(["TOTAL", ...state.players.map(p=>p.score), "", "", ""]);
  const csv = rows.map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}); const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='gandengyan_scores_mobile_full_spring.csv'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}

/* ================== å®æ—¶æ’åï¼ˆæ˜¾è‘—åˆ†æ•°ï¼‰ ================== */
function renderRank(){
  const box = document.getElementById('rankList'); box.innerHTML="";
  const meta = document.getElementById('rankMeta');
  const arr = state.players.map((p,i)=>({i, name:p.name, score:p.score}));
  arr.sort((a,b)=> b.score - a.score || a.i - b.i);

  if(meta){
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    meta.textContent = `å…± ${arr.length} äºº ï½œ æ›´æ–°äº ${hh}:${mm}`;
  }

  const nf = new Intl.NumberFormat('zh-CN');
  arr.forEach((r,idx)=>{
    const card = document.createElement('div');
    const medalClass = idx===0?'gold':idx===1?'silver':idx===2?'bronze':'';
    let pv = r.score>0?'pos':(r.score<0?'neg':'zero');
    card.className = `rankCard ${idx<3?'top':''} ${pv}`;
    card.innerHTML = `
      <div class="rankNo ${medalClass}">${idx+1}</div>
      <div class="rankName">${escapeHTML(r.name)}</div>
      <div class="rankScore mono">${r.score>=0?'+':''}${nf.format(r.score)}<span class="unit">åˆ†</span></div>
    `;
    box.appendChild(card);
  });
}

/* ================== ç‚¸å¼¹äº¤äº’ï¼ˆæ— è¾“å…¥æ¡†ï¼Œä»…æŒ‰é’®ï¼‰ ================== */
function bindBombUI(){
  const dec = document.getElementById('bombDec');
  const inc = document.getElementById('bombInc');
  const rst = document.getElementById('bombReset');
  updateBombUI();

  function sync(newVal){
    const k = Math.max(0, Math.floor(Number(newVal)||0));
    if (k !== state.bombCount){ pulseBomb(); }
    state.bombCount = k;
    updateBombUI(); save(); recomputePreview();
  }
  dec.addEventListener('click', ()=> sync(state.bombCount - 1));
  inc.addEventListener('click', ()=> sync(state.bombCount + 1));
  rst.addEventListener('click', ()=> sync(0));
}

/* ================== å…¶å®ƒæ“ä½œ ================== */
function zeroScores(){ if(!confirm("å°†æ‰€æœ‰ç©å®¶åˆ†æ•°æ¸…é›¶ï¼Ÿ")) return; state.players.forEach(p=>p.score=0); renderPlayers(); renderRank(); save(); }
function resetNames(){ state.players.forEach((p,i)=> p.name="ç©å®¶"+(i+1)); renderPlayers(); renderRemainArea(); renderQuickWinner(); save(); }
function applyPlayerCount(newN){
  newN = Math.max(2, Math.min(12, Math.floor(newN)));
  if (newN===N()) return;
  if (!confirm("æ›´æ”¹äººæ•°ä¼šæ¸…ç©ºå†å²è®°å½•å¹¶å¯èƒ½é‡ç½®éƒ¨åˆ†åå­—ï¼Œç¡®å®šå—ï¼Ÿ")) return;
  for(const h of state.history){
    for(let i=0;i<h.delta.length;i++){
      if(i<state.players.length) state.players[i].score -= (h.delta[i]||0);
    }
  }
  state.history=[];
  if (newN>N()){
    const start=N();
    for(let i=start;i<newN;i++) state.players.push({name:"ç©å®¶"+(i+1), score:0});
  }else{
    state.players.length=newN;
  }
  state.remainWinner=0;
  renderPlayers(); renderRemainArea(); renderQuickWinner(); renderRank(); renderHistory(); save(); recomputePreview();
}
function undo(){ if(!state.history.length) return; deleteRound(state.history.length-1); }

/* ================== Toast ================== */
let toastTimer=null;
function showToast(text){
  const t=document.getElementById('toast');
  t.textContent=text; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=> t.classList.remove('show'), 1500);
}

/* ================== Dock ç´§è´´Tab ================== */
function stickDockToTab(){
  const tab = document.querySelector('.tabbar');
  const dock = document.getElementById('subtotalDock');
  if(!tab || !dock) return;
  const h = tab.getBoundingClientRect().height || 64;
  dock.style.bottom = `calc(${h}px + env(safe-area-inset-bottom))`;
}
window.addEventListener('resize', stickDockToTab);

/* ================== åˆå§‹åŒ– ================== */
function init(){
  load();
  go('score'); // é»˜è®¤â€œè®°åˆ†â€
  renderPlayers(); renderRemainArea(); renderQuickWinner(); renderRank(); renderHistory();
  bindBombUI(); switchMode(); updateBombUI(); recomputePreview();
  stickDockToTab();

  // äº¤äº’ç»‘å®š
  document.getElementById('mode').addEventListener('change', switchMode);
  document.getElementById('commit_m').addEventListener('click', commitRound);
  document.getElementById('undo').addEventListener('click', undo);
  document.getElementById('exportCsv').addEventListener('click', exportCsv);
  document.getElementById('clearHistory').addEventListener('click', clearHistory);
  document.getElementById('minusP').addEventListener('click', ()=> applyPlayerCount(N()-1));
  document.getElementById('plusP').addEventListener('click', ()=> applyPlayerCount(N()+1));
  document.getElementById('applyP').addEventListener('click', ()=> applyPlayerCount(Number(document.getElementById('setP').value||N())));
  document.getElementById('zeroScores').addEventListener('click', zeroScores);
  document.getElementById('resetNames').addEventListener('click', resetNames);
}
init();
</script>
</body>
</html>
